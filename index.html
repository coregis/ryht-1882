<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Raise Your Hand Texas SB 1882 Web Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css' rel='stylesheet' />
		<link href="css/ryht-1882-style.css" rel="stylesheet" />
		<style>
			body { margin:0; padding:0; }
			#map { position:absolute; top:0; bottom:0; width:100%; }
			.mapboxgl-popup {
				max-width: 240px;
				font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
			}

		</style>
</head>
<body>

<div id='map'></div>

<div class='legend'>
	<div class='legend-title'>Potential Funding Increases by District Under SB 1882</div>
		<div class='legend-subtitle'>Dollars per Average Daily Attendance (ADA)</div>
			<div class='legend-scale'>
				  <ul class='legend-labels'>
					<li><span style='background:#eeffe6;'></span>No increase</li>
					<li><span style='background:#b8e65c;'></span>$1 - $1,000</li>
					<li><span style='background:#90bd3e;'></span>$1,001 - $1,500</li>
					<li><span style='background:#6e9623;'></span>$1,501 - $2,000</li>
					<li><span style='background:#4d7300;'></span>More than $2,000</li>
					<li><span><img class="charter" src="markers/charter_marker.svg"></img></span>Charter Schools</li>
				  </ul>
			</div>			
		<div class='legend-source'>Source: <a href="https://www.raiseyourhandtexas.org/"  target="_blank">Raise Your Hand Texas</a></div>
		<div class='map-credit'>Map design by <a href="http://www.coregis.net/"  target="_blank">CORE GIS</a></div>
	</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZS1naXMiLCJhIjoiaUxqQS1zQSJ9.mDT5nb8l_dWIHzbnOTebcQ';

//set bounds to Texas
			var bounds = [
					[-114.9594,21.637], // southwest coords
					[-85.50,39.317] // northeast coords
				];


				
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/core-gis/cjm2gaa5p950g2rn6pg3u90ko', // stylesheet location; this is the migrated style with markers turned OFF and 1882 polys on
    center: [-98.560161, 31.314160], // starting position [lng, lat]
	zoom: 5.4, // starting zoom
	maxBounds: bounds // sets bounds as max
	
});

map.on('load', function () {

	map.addSource('districts_1882',{
		type:'vector',
		url:'mapbox://core-gis.b73007d3'
		});
		//Add a map layer for all the districts

	map.addLayer({
		"id":"districts_1882",
		"type":"fill",
		"source":"districts_1882",
		"source-layer":"texas_districts_1882_v3",
		"layout":{		},
		"paint":{
			'fill-color': 'rgba(200, 100, 240, 0)',
            'fill-outline-color': 'rgba(200, 100, 240, 0)'
			}	
	});
});

map.on('load', function () {

	map.addSource('charter_schools',{
		type:'vector',
		url:'mapbox://core-gis.1njhmpnd',
		});
		//Add a map layer for charter schools

	map.addLayer({
		"id":"charter_schools",
		"type":"fill",
		"source":"charter_schools",
		"source-layer":"charter_schools_v1-6wolgf",
		"layout":{		},
		"paint":{
			'fill-color': 'rgba(200, 100, 240, 0)',
            'fill-outline-color': 'rgba(200, 100, 240, 0)'
			}	
	});
});


	// When a click event occurs on a feature in the districts layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'districts_1882', function (e) {
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(fillpopup(e.features[0].properties))
            .addTo(map);
		console.log(e.features[0].properties);
    });
	
	 // Change the cursor to a pointer when the mouse is over the districts layer.
    map.on('mouseenter', 'districts_1882', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves
    map.on('mouseleave', 'districts_1882', function () {
        map.getCanvas().style.cursor = '';
    });
	
	function fillpopup(data){
		var html = "";
		html = html + "<span class='varname'>District Name: </span> <span class='attribute'>" + data.SchDistNam + "</span>";
		html = html + "<br>"
		html = html + "<span class='varname'>Total Increase: </span> <span class='attribute'>" + data.SumOfGain + "</span>";
		html = html + "<br>"
		html = html + "<span class='varname'>Increase per ADA</span> <span class='attribute'>" + data.EstADAIn +"</span>";
		return html;
		//this will return the string to the calling function
		
	}

	//Testing popup on hover
		map.on('load', function() {

		  // Create a popup, but don't add it to the map yet.
		  var popup = new mapboxgl.Popup({
			closeButton: false,
			closeOnClick: false
		  });

		  function showPopup(e) {
			// Updates the cursor to a hand (interactivity)
			map.getCanvas().style.cursor = 'pointer';

			// Show the popup at the coordinates with some data
			popup.setLngLat(e.features[0].geometry.coordinates)
			  .setHTML(checkEmpty(e.features[0].properties.CAMPNAME))
			  .addTo(map);
		  }

		  function hidePopup() {
			map.getCanvas().style.cursor = '';
			popup.remove();
		  }

		  function checkEmpty(info) {
			return (info) ? info : "No data";
		  }

		// CHANGE: Add layer names that need to be interactive

		  map.on('mouseenter', 'charter-schools-v2', showPopup);
		  map.on('mouseleave', 'charter-schools-v2', hidePopup);

		});
	
	/*	
	// When a click event occurs on a feature in the charter schools layer, open a popup at the
    // location of the click, with description HTML from its properties.
   
   map.on('click', function(e) {
		  var features = map.queryRenderedFeatures(e.point, {
			layers: ['charter-schools-v1-6wolgf'] // replace this with the name of the layer
		  });

		  if (!features.length) {
			return;
		  }

		  var feature = features[0];

		  var popup = new mapboxgl.Popup({ offset: [0, -15] })
			.setLngLat(feature.geometry.coordinates)
			.setHTML("<span class='varname'>School Name: </span><span class='attribute'>" + feature.properties.CAMPNAME + "<br><span class='varname'>Charter Type: </span><span class='attribute'>" + feature.properties.CHART_TYPE )
			.setLngLat(feature.geometry.coordinates)
			.addTo(map);
		});
		*/

// Add zoom controls to the map, with the compass turned off; position is modified in CSS
		map.addControl(new mapboxgl.NavigationControl({
			// Hide rotation control.
			showCompass: false
			}), 'bottom-right');
	
</script>

</body>
</html>